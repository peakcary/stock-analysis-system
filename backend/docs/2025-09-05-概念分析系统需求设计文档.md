# 2025-09-05 股票概念分析系统需求设计文档

## 📄 文档概述

**文档版本**: 1.0  
**创建日期**: 2025-09-05  
**项目阶段**: 需求分析与系统设计  
**功能模块**: 股票概念排名分析系统

## 🎯 业务需求分析

### **核心业务流程**

```
每日数据导入 → 后台排名计算 → 概念统计分析 → 用户查询展示
     ↓              ↓              ↓              ↓
   CSV/TXT      个股概念排名    概念总和计算    三大查询界面
   文件导入      日度更新        历史对比        图表展示
```

### **详细功能需求**

#### **1. 数据处理需求**
- ✅ 每日自动导入CSV和TXT数据
- 🔄 **新增**: 导入后自动触发排名计算
- 🔄 **新增**: 计算所有概念中个股的每日排名
- 🔄 **新增**: 计算概念每日总和（所有个股热度求和）

#### **2. 个股查询需求**
- 🔍 输入股票代码 → 返回股票信息和所属概念
- 📊 概念按热度总和从高到低排列
- 🎯 点击概念 → 显示该概念所有个股
- 📑 分页显示：前10个显示，其余隐藏，可展开查看

#### **3. 概念股查询需求**
- 🔢 可配置查询前N的概念股（如前3、前10）
- 📈 返回所有概念的前N个股票
- 📊 按概念热度总和排序

#### **4. 创新高分析需求**
- 📅 可配置时间范围（如10天内）
- 🚀 识别概念总和创新高的概念
- 📊 按个股排名展示这些概念的股票
- 📈 提供历史对比数据

#### **5. 图表展示需求**
- 📊 个股在所选概念内的排名趋势图
- 📈 概念每日总和趋势图
- 🎯 点击任意股票代码 → 查看详细图表
- 📱 响应式图表设计

#### **6. 转债专项需求**
- 💰 1开头的转债代码单独处理
- 📊 转债概念排行功能
- 📈 转债专用图表界面
- 🔍 转债查询功能独立

## 🏗️ 系统架构设计

### **整体架构**

```
┌─────────────────────────────────────────────────────────────┐
│                     前端用户界面层                          │
├─────────────────┬─────────────────┬─────────────────────────┤
│   个股查询界面   │   创新高分析界面 │     转债分析界面        │
│   Stock Query   │   Innovation    │   Convertible Bond      │
│   Interface     │   Analysis      │   Analysis Interface    │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                     API接口层                               │
├─────────────────┬─────────────────┬─────────────────────────┤
│   查询服务API    │   排名分析API   │     图表数据API         │
│   Query Service │   Ranking API   │   Chart Data API        │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                     业务逻辑层                              │
├─────────────────┬─────────────────┬─────────────────────────┤
│   概念分析服务   │   排名计算服务   │     数据统计服务        │
│   Concept       │   Ranking       │   Statistics Service   │
│   Analysis      │   Calculator    │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                     数据处理层                              │
├─────────────────┬─────────────────┬─────────────────────────┤
│   数据导入服务   │   后台计算任务   │     数据缓存服务        │
│   Data Import   │   Background    │   Cache Service         │
│   Service       │   Calculator    │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                     数据存储层                              │
├─────────────────┬─────────────────┬─────────────────────────┤
│     核心数据     │    排名数据     │      缓存存储           │
│   Core Database │   Ranking Data  │   Redis Cache           │
│   (MySQL)       │   (MySQL)       │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 💾 数据库设计

### **新增表结构**

#### **1. 每日概念排名表**
```sql
CREATE TABLE daily_concept_rankings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    concept_id INT NOT NULL,
    stock_id INT NOT NULL,
    trade_date DATE NOT NULL,
    rank_in_concept INT NOT NULL,           -- 股票在概念内的排名
    heat_value DECIMAL(15,2) NOT NULL,      -- 热度值
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_concept_stock_date (concept_id, stock_id, trade_date),
    KEY idx_concept_date (concept_id, trade_date),
    KEY idx_stock_date (stock_id, trade_date),
    KEY idx_trade_date (trade_date),
    
    FOREIGN KEY (concept_id) REFERENCES concepts(id),
    FOREIGN KEY (stock_id) REFERENCES stocks(id)
);
```

#### **2. 每日概念汇总表**
```sql
CREATE TABLE daily_concept_summaries (
    id INT PRIMARY KEY AUTO_INCREMENT,
    concept_id INT NOT NULL,
    trade_date DATE NOT NULL,
    total_heat_value DECIMAL(15,2) NOT NULL,    -- 概念总热度值
    stock_count INT NOT NULL,                   -- 概念内股票数量
    avg_heat_value DECIMAL(15,2) NOT NULL,      -- 平均热度值
    max_heat_value DECIMAL(15,2) NOT NULL,      -- 最高热度值
    min_heat_value DECIMAL(15,2) NOT NULL,      -- 最低热度值
    is_new_high BOOLEAN DEFAULT FALSE,          -- 是否创新高
    new_high_days INT DEFAULT 0,                -- 创新高天数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_concept_date (concept_id, trade_date),
    KEY idx_concept_id (concept_id),
    KEY idx_trade_date (trade_date),
    KEY idx_total_heat (total_heat_value DESC),
    KEY idx_new_high (is_new_high, trade_date),
    
    FOREIGN KEY (concept_id) REFERENCES concepts(id)
);
```

#### **3. 分析任务记录表**
```sql
CREATE TABLE daily_analysis_tasks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_date DATE NOT NULL,
    task_type ENUM('ranking_calculation', 'summary_calculation', 'innovation_analysis') NOT NULL,
    status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending',
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    error_message TEXT,
    processed_records INT DEFAULT 0,
    total_records INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_date_task (trade_date, task_type),
    KEY idx_trade_date (trade_date),
    KEY idx_status (status)
);
```

## 🔧 核心服务设计

### **1. 排名计算服务 (RankingCalculatorService)**

```python
class RankingCalculatorService:
    """概念排名计算服务"""
    
    async def calculate_daily_rankings(self, trade_date: date) -> Dict[str, Any]:
        """计算指定日期的概念排名"""
        
    async def calculate_concept_summaries(self, trade_date: date) -> Dict[str, Any]:
        """计算概念汇总数据"""
        
    async def detect_innovation_highs(self, trade_date: date, days_back: int = 10) -> List[int]:
        """检测创新高概念"""
        
    async def recalculate_rankings(self, start_date: date, end_date: date) -> Dict[str, Any]:
        """重新计算指定日期范围的排名"""
```

### **2. 概念分析服务 (ConceptAnalysisService)**

```python
class ConceptAnalysisService:
    """概念分析服务"""
    
    async def get_stock_concepts_ranked(self, stock_code: str, trade_date: date = None) -> Dict[str, Any]:
        """获取股票的所有概念（按热度排序）"""
        
    async def get_concept_stocks_ranked(self, concept_id: int, trade_date: date = None, 
                                      limit: int = 10, offset: int = 0) -> Dict[str, Any]:
        """获取概念内股票排名"""
        
    async def get_top_concepts_stocks(self, top_n: int = 10, trade_date: date = None) -> Dict[str, Any]:
        """获取前N概念的所有股票"""
        
    async def get_innovation_concept_stocks(self, days_back: int = 10, 
                                          trade_date: date = None) -> Dict[str, Any]:
        """获取创新高概念的股票"""
        
    async def get_convertible_bond_analysis(self, trade_date: date = None) -> Dict[str, Any]:
        """获取转债分析数据"""
```

### **3. 图表数据服务 (ChartDataService)**

```python
class ChartDataService:
    """图表数据服务"""
    
    async def get_stock_ranking_chart(self, stock_code: str, concept_id: int, 
                                    days_back: int = 30) -> Dict[str, Any]:
        """获取股票在概念内的排名图表数据"""
        
    async def get_concept_trend_chart(self, concept_id: int, 
                                    days_back: int = 30) -> Dict[str, Any]:
        """获取概念热度趋势图表数据"""
        
    async def get_stock_detail_chart(self, stock_code: str, 
                                   days_back: int = 30) -> Dict[str, Any]:
        """获取股票详细图表数据"""
        
    async def get_convertible_bond_chart(self, stock_code: str, 
                                       days_back: int = 30) -> Dict[str, Any]:
        """获取转债图表数据"""
```

## 🔄 业务流程设计

### **每日数据处理流程**

```python
async def daily_data_processing_workflow(trade_date: date):
    """每日数据处理工作流"""
    
    # 1. 数据导入完成后触发
    await trigger_daily_analysis(trade_date)
    
    # 2. 计算概念内股票排名
    ranking_result = await ranking_calculator.calculate_daily_rankings(trade_date)
    
    # 3. 计算概念汇总统计
    summary_result = await ranking_calculator.calculate_concept_summaries(trade_date)
    
    # 4. 检测创新高概念
    innovation_concepts = await ranking_calculator.detect_innovation_highs(trade_date)
    
    # 5. 更新缓存
    await cache_service.update_daily_cache(trade_date)
    
    # 6. 发送完成通知
    await notification_service.send_completion_notice(trade_date)
```

### **查询处理流程**

```python
# 个股查询流程
stock_code = "000001"
stock_info = await concept_analysis.get_stock_concepts_ranked(stock_code)

# 概念股查询流程  
concept_id = 1
concept_stocks = await concept_analysis.get_concept_stocks_ranked(
    concept_id, limit=10, offset=0
)

# 创新高分析流程
innovation_data = await concept_analysis.get_innovation_concept_stocks(days_back=10)
```

## 🎨 API接口设计

### **1. 个股查询相关接口**

```python
# 获取股票概念信息
GET /api/v1/stocks/{stock_code}/concepts
# 获取概念内股票排名
GET /api/v1/concepts/{concept_id}/stocks?limit=10&offset=0
# 获取股票图表数据
GET /api/v1/stocks/{stock_code}/charts?concept_id=1&days=30
```

### **2. 排名分析相关接口**

```python
# 获取前N概念股
GET /api/v1/rankings/top-concepts?top_n=10&date=2025-08-28
# 获取创新高概念股
GET /api/v1/rankings/innovation-concepts?days_back=10&date=2025-08-28
# 获取概念趋势图表
GET /api/v1/concepts/{concept_id}/trend-chart?days=30
```

### **3. 转债分析相关接口**

```python
# 获取转债概念分析
GET /api/v1/convertible-bonds/concepts
# 获取转债排名
GET /api/v1/convertible-bonds/rankings?concept_id=1
# 获取转债图表
GET /api/v1/convertible-bonds/{bond_code}/charts
```

## 📊 界面功能设计

### **界面1: 个股查询界面**

**功能组件**:
```typescript
// 查询组件
StockSearchComponent {
  - 股票代码输入框
  - 搜索按钮
  - 股票基础信息显示
}

// 概念列表组件
ConceptListComponent {
  - 概念名称（按热度排序）
  - 概念热度值
  - 点击展开概念股
}

// 概念股票列表组件
ConceptStockListComponent {
  - 前10股票显示
  - "显示更多"按钮
  - 股票排名和热度
  - 股票代码点击链接
}

// 图表组件
StockChartComponent {
  - 股票在概念内排名图表
  - 概念总和趋势图表
  - 图表时间范围选择
}
```

### **界面2: 创新高分析界面**

**功能组件**:
```typescript
// 参数设置组件
InnovationParameterComponent {
  - 时间范围输入(天数)
  - 日期选择器
  - 分析按钮
}

// 创新高概念列表
InnovationConceptListComponent {
  - 创新高概念名称
  - 创新高天数显示
  - 概念热度变化
  - 点击查看概念股
}

// 概念股排名组件
ConceptStockRankingComponent {
  - 概念内股票排名表
  - 热度值和涨幅显示
  - 股票图表链接
}
```

### **界面3: 转债分析界面**

**功能组件**:
```typescript
// 转债概念排名组件
ConvertibleBondConceptComponent {
  - 转债概念列表
  - 概念热度排名
  - 转债数量统计
}

// 转债排名列表组件
ConvertibleBondRankingComponent {
  - 转债代码和名称
  - 转债热度排名
  - 正股对应关系
}

// 转债图表组件
ConvertibleBondChartComponent {
  - 转债热度趋势图
  - 转债概念排名图
  - 与正股对比图
}
```

## ⚡ 性能优化策略

### **1. 数据库优化**
- 合理的索引设计
- 分区表处理历史数据
- 读写分离架构
- 查询结果缓存

### **2. 计算优化**
- 异步批量计算
- 增量更新机制
- 定时任务调度
- 计算结果预存

### **3. 缓存策略**
- Redis缓存热点数据
- 分层缓存设计
- 缓存更新策略
- 缓存穿透防护

## 📈 开发计划

### **Phase 1: 数据计算层 (3-4天)**
- [ ] 排名计算服务开发
- [ ] 概念汇总统计功能
- [ ] 创新高检测算法
- [ ] 后台任务调度

### **Phase 2: API接口层 (2-3天)**
- [ ] 查询服务API开发
- [ ] 排名分析API开发
- [ ] 图表数据API开发
- [ ] 转债分析API开发

### **Phase 3: 业务逻辑完善 (2-3天)**
- [ ] 分页查询优化
- [ ] 数据验证和容错
- [ ] 缓存机制实现
- [ ] 性能监控

### **Phase 4: 测试和优化 (1-2天)**
- [ ] 单元测试和集成测试
- [ ] 性能测试和调优
- [ ] 错误处理完善
- [ ] 文档完善

---

**预计总开发时间**: 8-12天  
**核心挑战**: 大数据量的排名计算性能优化  
**关键成功因素**: 高效的算法设计和合理的缓存策略

## 📈 系统更新记录

### 2025-09-12 v2.5.0 更新
**个股分析页面重构**：
- 🔄 重构个股分析页面，改为按TXT文件股票列表展示
- 🆕 新增 `/stocks/daily-summary` API，支持获取指定日期所有股票汇总
- 📊 个股概念弹窗按概念总交易量排序，提升数据可读性
- 🔍 新增调试API `/debug/concept-volumes` 用于概念交易量分析
- 🎯 优化概念排序逻辑，后端API和前端双重保障按总交易量排序

**技术改进**：
- 统一股票代码匹配逻辑，确保数据一致性
- 优化API排序参数，明确指定排序字段和顺序
- 增强错误处理和数据验证功能
- 改进用户界面交互体验