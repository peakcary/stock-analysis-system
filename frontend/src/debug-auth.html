<!DOCTYPE html>
<html>
<head>
    <title>认证调试工具</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>管理员认证调试</h1>
    <div id="status"></div>
    <button onclick="checkAuth()">检查认证状态</button>
    <button onclick="clearAuth()">清除认证信息</button>
    <button onclick="testLogin()">测试登录</button>
    <button onclick="testApi()">测试API调用</button>
    <pre id="output"></pre>

    <script>
        const log = (message) => {
            document.getElementById('output').textContent += new Date().toISOString() + ': ' + message + '\n';
        };

        const checkAuth = () => {
            const token = localStorage.getItem('admin_token');
            const user = localStorage.getItem('admin_user');
            log('Token: ' + (token ? token.substring(0, 50) + '...' : 'null'));
            log('User: ' + (user || 'null'));
        };

        const clearAuth = () => {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            log('认证信息已清除');
        };

        const testLogin = async () => {
            try {
                const response = await axios.post('http://localhost:3007/api/v1/admin/auth/login', {
                    username: 'admin',
                    password: 'admin123'
                });
                log('登录成功: ' + JSON.stringify(response.data));
                localStorage.setItem('admin_token', response.data.access_token);
                localStorage.setItem('admin_user', JSON.stringify(response.data.admin_info));
            } catch (error) {
                log('登录失败: ' + error.message);
            }
        };

        const testApi = async () => {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                log('没有token，请先登录');
                return;
            }

            // 测试多个API端点
            const endpoints = [
                '/api/v1/stocks/count',
                '/api/v1/concepts/count', 
                '/api/v1/stocks/simple?limit=10',
                '/api/v1/admin/auth/me'
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await axios.get('http://localhost:3007' + endpoint, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    log(`${endpoint} 成功: ${JSON.stringify(response.data)}`);
                } catch (error) {
                    log(`${endpoint} 失败: ${error.response?.status} - ${error.message}`);
                    if (error.response?.data) {
                        log(`错误详情: ${JSON.stringify(error.response.data)}`);
                    }
                }
            }
        };

        // 页面加载时检查状态
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
    </script>
</body>
</html>